<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q Mailbox</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; margin-bottom: 20px; color: #333; }
        .status { padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
        .status.disconnected { background: #fee; color: #c33; }
        .status.connected { background: #efe; color: #3c3; }
        .messages { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 20px; background: #fafafa; }
        .message { padding: 8px; margin-bottom: 8px; border-radius: 6px; background: white; border-left: 3px solid #007aff; }
        .message .meta { font-size: 12px; color: #666; margin-bottom: 4px; }
        .message .text { font-size: 14px; color: #333; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        button { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #007aff; color: white; }
        .btn-secondary { background: #5ac8fa; color: white; }
        .btn-auth { background: #34c759; color: white; width: 100%; margin-bottom: 20px; }
        .btn-primary:active { background: #0051d5; }
        .btn-secondary:active { background: #32ade6; }
        .btn-auth:active { background: #248a3d; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíô Q Mailbox</h1>
        
        <div id="authSection">
            <button class="btn-auth" onclick="handleAuth()">üîê –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ Google</button>
        </div>

        <div id="mailboxSection" class="hidden">
            <div id="status" class="status disconnected">
                ‚ö†Ô∏è –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Google Drive
            </div>

            <div class="messages" id="messages">
                <div style="text-align: center; color: #999; padding: 20px;">
                    –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î
                </div>
            </div>

            <div class="input-group">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." />
                <button class="btn-primary" onclick="sendMessage()">üì§ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
            </div>

            <div class="input-group">
                <button class="btn-secondary" onclick="checkMessages()" style="flex: 1;">üîç –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
                <button class="btn-secondary" onclick="newSession()" style="flex: 1; background: #ff3b30;">üóëÔ∏è –ù–æ–≤–∏–π —Å–µ–∞–Ω—Å</button>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CONFIG = {
            clientId: '737474602371-6ip4hr60vrv69e84h05b386bde7ag5va.apps.googleusercontent.com',
            apiKey: 'AIzaSyDuSpV6pdXso-hN-GeTmFRSbEsrGKUet8o',
            scope: 'https://www.googleapis.com/auth/drive',
            mailboxPath: 'mailbox/q_vadym_chat/messages.txt'
        };

        let accessToken = null;
        let fileId = null;
        let parentFolderId = null;  // –î–æ–¥–∞—é parent folder ID
        let tokenClient = null;

        window.onload = function() {
            gapi.load('client', initGapi);
        };

        function initGapi() {
            gapi.client.init({
                apiKey: CONFIG.apiKey,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
            });
        }

        function handleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.clientId,
                scope: CONFIG.scope,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        gapi.client.setToken({ access_token: accessToken });
                        
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('mailboxSection').classList.remove('hidden');
                        document.getElementById('status').className = 'status connected';
                        document.getElementById('status').textContent = '‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Google Drive';
                        
                        findMailboxFile();
                    }
                }
            });
            tokenClient.requestAccessToken();
        }

        async function findMailboxFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='messages.txt' and trashed=false`,
                    fields: 'files(id, name, parents)',
                    spaces: 'drive'
                });

                if (response.result.files && response.result.files.length > 0) {
                    fileId = response.result.files[0].id;
                    parentFolderId = response.result.files[0].parents ? response.result.files[0].parents[0] : null;
                    console.log('Mailbox file found:', fileId, 'Parent:', parentFolderId);
                    checkMessages();
                } else {
                    console.log('Mailbox file not found, creating...');
                    await createMailboxFile();
                }
            } catch (error) {
                console.error('Error finding mailbox:', error);
            }
        }

        async function createMailboxFile() {
            try {
                // –°–ø–æ—á–∞—Ç–∫—É –∑–Ω–∞–π—Ç–∏/—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–∞–ø–∫—É mailbox/q_vadym_chat
                const folderPath = ['mailbox', 'q_vadym_chat'];
                let parentId = 'root';
                
                for (const folderName of folderPath) {
                    const folderResponse = await gapi.client.drive.files.list({
                        q: `name='${folderName}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                        fields: 'files(id)'
                    });
                    
                    if (folderResponse.result.files && folderResponse.result.files.length > 0) {
                        parentId = folderResponse.result.files[0].id;
                    } else {
                        const createFolderResponse = await gapi.client.drive.files.create({
                            resource: {
                                name: folderName,
                                mimeType: 'application/vnd.google-apps.folder',
                                parents: [parentId]
                            },
                            fields: 'id'
                        });
                        parentId = createFolderResponse.result.id;
                    }
                }
                
                // –¢–µ–ø–µ—Ä —Å—Ç–≤–æ—Ä–∏—Ç–∏ messages.txt –≤ –ø–∞–ø—Ü—ñ
                const response = await gapi.client.drive.files.create({
                    resource: {
                        name: 'messages.txt',
                        mimeType: 'text/plain',
                        parents: [parentId]
                    },
                    fields: 'id'
                });
                
                fileId = response.result.id;
                console.log('Mailbox file created:', fileId);
                alert('‚úÖ Mailbox —Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ –≤ mailbox/q_vadym_chat/! –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.');
                checkMessages();
            } catch (error) {
                console.error('Error creating mailbox:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É: ' + error.message);
            }
        }

        async function newSession() {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π mailbox —ñ –ø–æ—á–∞—Ç–∏ –Ω–æ–≤–∏–π —Å–µ–∞–Ω—Å?')) {
                return;
            }

            try {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π —Ñ–∞–π–ª
                if (fileId) {
                    await gapi.client.drive.files.delete({
                        fileId: fileId
                    });
                    console.log('Old mailbox deleted');
                }

                // –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π
                fileId = null;
                await createMailboxFile();
            } catch (error) {
                console.error('Error creating new session:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Å–µ–∞–Ω—Å—É: ' + error.message);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!fileId) {
                alert('Mailbox —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            try {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ lock —Ñ–∞–π–ª
                const lockExists = await checkLockFile();
                if (lockExists) {
                    alert('‚è≥ QBS –ø–∏—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∑–∞—á–µ–∫–∞–π—Ç–µ...');
                    return;
                }

                // –õ–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å (–Ω–µ UTC!)
                const now = new Date();
                const timestamp = now.getFullYear() + '-' + 
                    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(now.getDate()).padStart(2, '0') + ' ' +
                    String(now.getHours()).padStart(2, '0') + ':' + 
                    String(now.getMinutes()).padStart(2, '0') + ':' + 
                    String(now.getSeconds()).padStart(2, '0');
                const formattedMessage = `[${timestamp}] [FROM: QMS] [TO: Q]\n${message}\n\n`;

                const currentContent = await readFile();
                const newContent = currentContent + formattedMessage;

                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: newContent
                });

                input.value = '';
                
                // –û–Ω–æ–≤–∏—Ç–∏ UI (–ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –≤–µ—Å—å —Ñ–∞–π–ª –∑–∞–Ω–æ–≤–æ)
                await checkMessages();
            } catch (error) {
                console.error('Error sending message:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }

        async function checkMessages() {
            if (!fileId) return;

            try {
                const content = await readFile();
                parseAndDisplayMessages(content);
            } catch (error) {
                console.error('Error checking messages:', error);
            }
        }

        async function readFile() {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            return response.body || '';
        }

        async function checkLockFile() {
            if (!parentFolderId) {
                console.error('Parent folder ID not found');
                return false;
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='.lock' and '${parentFolderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                const lockExists = response.result.files && response.result.files.length > 0;
                console.log('Lock check:', lockExists);
                return lockExists;
            } catch (error) {
                console.error('Error checking lock:', error);
                return false;
            }
        }

        function parseAndDisplayMessages(content) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            if (!content.trim()) {
                messagesDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
                return;
            }

            const blocks = content.split('\n\n').filter(b => b.trim());
            
            for (const block of blocks) {
                const lines = block.split('\n');
                const firstLine = lines[0];
                
                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ SYSTEM –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if (firstLine.includes('[SYSTEM]')) continue;
                
                // –ü–∞—Ä—Å–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ FROM/TO
                const match = firstLine.match(/\[([^\]]+)\].*\[FROM: ([^\]]+)\] \[TO: ([^\]]+)\]/);
                if (match) {
                    const timestamp = match[1];
                    const from = match[2];
                    const text = lines.slice(1).join(' ').trim();
                    
                    if (text) {
                        addMessageToUI(from, text, timestamp);
                    }
                }
            }
        }

        function addMessageToUI(from, text, timestamp) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.innerHTML = `
                <div class="meta">${from} ‚Ä¢ ${timestamp}</div>
                <div class="text">${text.trim()}</div>
            `;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
