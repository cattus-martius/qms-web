<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q Mailbox</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; background: #000; color: #fff; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { font-size: 20px; margin-bottom: 15px; color: #fff; }
        .status { padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; background: #2a2a2a; }
        .status.disconnected { color: #ff6b6b; }
        .status.connected { color: #51cf66; }
        .messages { max-height: 400px; overflow-y: auto; border: 1px solid #333; border-radius: 6px; padding: 10px; margin-bottom: 10px; background: #0a0a0a; }
        .message { padding: 8px 12px; margin-bottom: 8px; border-radius: 6px; background: #1a1a1a; }
        .message .meta { font-size: 11px; color: #666; margin-bottom: 4px; }
        .message .text { font-size: 14px; color: #fff; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #444; border-radius: 6px; font-size: 16px; background: #2a2a2a; color: #fff; }
        input[type="text"]:focus { outline: none; border-color: #555; }
        button { padding: 12px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500; background: #333; color: #fff; }
        button:hover { background: #444; }
        button:active { background: #555; }
        .btn-primary { background: #333; }
        .btn-secondary { background: #333; }
        .btn-auth { background: #333; width: 100%; margin-bottom: 20px; }
        .hidden { display: none; }
        .header-line { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .server-info { font-size: 12px; color: #666; }
        .tabs { display: flex; gap: 0; margin-bottom: 15px; border-bottom: 2px solid #333; }
        .tab-button { flex: 1; background: #1a1a1a; color: #aaa; border: none; padding: 12px; cursor: pointer; font-size: 16px; border-bottom: 3px solid transparent; }
        .tab-button.active { color: #fff; border-bottom-color: #fff; }
        .tab-button:hover { background: #2a2a2a; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .sensor-item { display: flex; align-items: center; height: 40px; padding: 8px; background: #2a2a2a; margin-bottom: 4px; border-radius: 4px; }
        .sensor-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
        .sensor-item label { flex: 1; font-size: 14px; color: #fff; cursor: pointer; }
        .sensor-value { font-size: 14px; color: #aaa; min-width: 100px; text-align: right; }
        h3 { color: #fff; margin-bottom: 15px; font-size: 18px; }
        .media-section { background: #2a2a2a; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .media-header { display: flex; align-items: center; margin-bottom: 10px; }
        .media-header input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
        .media-header label { font-size: 16px; color: #fff; cursor: pointer; flex: 1; }
        .media-status { color: #aaa; font-size: 14px; }
        #cameraPreview, #screenPreview { width: 100%; max-width: 300px; border-radius: 6px; background: #000; margin-top: 10px; display: none; }
        .media-button { padding: 8px 16px; background: #555; color: white; border: none; border-radius: 6px; cursor: not-allowed; font-size: 14px; margin-top: 10px; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-line">
            <h1>üíô Q Mailbox</h1>
            <span class="server-info" id="serverInfo">Google Drive: üî¥ Not ready</span>
        </div>
        
        <div id="authSection">
            <button class="btn-auth" onclick="handleAuth()">üîê –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ Google</button>
        </div>

        <div id="mailboxSection" class="hidden">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('chat')">Chat</button>
                <button class="tab-button" onclick="switchTab('media')">Media</button>
                <button class="tab-button" onclick="switchTab('settings')">Settings</button>
            </div>

            <!-- Chat Tab -->
            <div id="chat-tab" class="tab-content active">
                <div class="messages" id="messages">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î
                    </div>
                </div>

                <div class="input-group">
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." />
                    <button class="btn-primary" onclick="sendMessage()">‚Üí</button>
                </div>

                <div class="input-group">
                    <button class="btn-secondary" onclick="checkMessages()" style="flex: 1;">üîÑ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
                    <button class="btn-secondary" onclick="newSession()" style="flex: 1;">üóëÔ∏è –ù–æ–≤–∏–π —Å–µ–∞–Ω—Å</button>
                </div>
            </div>

            <!-- Media Tab -->
            <div id="media-tab" class="tab-content">
                <h3>Media Controls</h3>
                
                <!-- Camera Section -->
                <div class="media-section">
                    <div class="media-header">
                        <input type="checkbox" id="cbCamera">
                        <label for="cbCamera">üìπ Camera</label>
                        <span id="cameraStatus" class="media-status"></span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="media-button" id="btnSendFrame" style="background: #3498db; cursor: pointer; opacity: 1;">üì∏ Send Frame</button>
                            <div style="display: flex; gap: 8px;">
                                <button class="media-button" id="btnSendMotion" style="flex: 1; background: #3498db; cursor: pointer; opacity: 1;">üé¨ Send Motion</button>
                                <input type="number" id="motionFrames" min="2" max="30" value="5" style="width: 50px; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #2c2c2c; color: #fff; text-align: center;">
                            </div>
                        </div>
                        <video id="cameraPreview" autoplay playsinline style="width: 200px; height: 150px;"></video>
                    </div>
                </div>
                
                <!-- Microphone Section -->
                <div class="media-section">
                    <div class="media-header">
                        <input type="checkbox" id="cbMicrophone">
                        <label for="cbMicrophone">üé§ Microphone</label>
                        <span id="micStatus" class="media-status"></span>
                    </div>
                    <button class="media-button" id="btnRecord" style="background: #3498db; cursor: pointer; opacity: 1;">üé§ Record</button>
                </div>
                
                <!-- Speaker Section -->
                <div class="media-section">
                    <div class="media-header">
                        <input type="checkbox" id="cbSpeaker">
                        <label for="cbSpeaker">üîä Speaker</label>
                        <span id="speakerStatus" class="media-status"></span>
                    </div>
                    <button class="media-button" id="btnTestVoice" style="margin-bottom: 10px; background: #3498db; cursor: pointer; opacity: 1;">üé§ Test Voice</button>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <label style="color: #fff; min-width: 80px;">Speed:</label>
                        <input type="number" id="speakerRate" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 60px; padding: 4px; border: 1px solid #555; border-radius: 4px; background: #2c2c2c; color: #fff;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #fff; min-width: 80px;">Volume:</label>
                        <input type="range" id="speakerVolume" min="0" max="100" value="100" style="flex: 1;">
                        <span id="volumeValue" style="color: #fff; min-width: 40px;">100%</span>
                    </div>
                </div>
                
                <!-- Clipboard Section -->
                <div class="media-section">
                    <div class="media-header">
                        <label>üìã Clipboard</label>
                        <span id="clipboardStatus" class="media-status"></span>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: flex-start;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="media-button" id="btnRefreshClipboard" style="background: #3498db; cursor: pointer; opacity: 1;">üîÑ Refresh Clipboard</button>
                            <button class="media-button" id="btnSendClipboard" style="background: #3498db; cursor: pointer; opacity: 1;">üìã Send Clipboard</button>
                        </div>
                        <canvas id="screenPreview" style="max-width: 200px; max-height: 150px; border: 1px solid #555; border-radius: 4px; display: none;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <h3>Telemetry</h3>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbLight" checked>
                    <label for="cbLight">üí° Light</label>
                    <span id="tvLight" class="sensor-value">0 lux</span>
                </div>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbAccelerometer" checked>
                    <label for="cbAccelerometer">üìê Accelerometer</label>
                    <span id="tvAccelerometer" class="sensor-value">0, 0, 0</span>
                </div>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbGyroscope" checked>
                    <label for="cbGyroscope">üåÄ Gyroscope</label>
                    <span id="tvGyroscope" class="sensor-value">0, 0, 0</span>
                </div>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbCompass" checked>
                    <label for="cbCompass">üß≠ Compass</label>
                    <span id="tvCompass" class="sensor-value">0¬∞</span>
                </div>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbBattery" checked>
                    <label for="cbBattery">üîã Battery</label>
                    <span id="tvBattery" class="sensor-value">0%</span>
                </div>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbPressure" checked>
                    <label for="cbPressure">üîä Pressure</label>
                    <span id="tvPressure" class="sensor-value">0 hPa</span>
                </div>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbProximity" checked>
                    <label for="cbProximity">üëÜ Proximity</label>
                    <span id="tvProximity" class="sensor-value">far</span>
                </div>
                
                <div class="sensor-item">
                    <input type="checkbox" id="cbGPS">
                    <label for="cbGPS">üìç GPS</label>
                    <span id="tvGPS" class="sensor-value">off</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CONFIG = {
            clientId: '737474602371-6ip4hr60vrv69e84h05b386bde7ag5va.apps.googleusercontent.com',
            apiKey: 'AIzaSyDuSpV6pdXso-hN-GeTmFRSbEsrGKUet8o',
            scope: 'https://www.googleapis.com/auth/drive',
            mailboxPath: 'mailbox/q_vadym_chat/messages.txt'
        };

        let accessToken = null;
        let fileId = null;
        let parentFolderId = null;  // –î–æ–¥–∞—é parent folder ID
        let tokenClient = null;

        window.onload = function() {
            gapi.load('client', initGapi);
        };

        function initGapi() {
            gapi.client.init({
                apiKey: CONFIG.apiKey,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
            });
        }

        function handleAuth() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.clientId,
                scope: CONFIG.scope,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        gapi.client.setToken({ access_token: accessToken });
                        
                        document.getElementById('authSection').classList.add('hidden');
                        document.getElementById('mailboxSection').classList.remove('hidden');
                        document.getElementById('serverInfo').textContent = 'Google Drive: üü¢ Ready';
                        
                        findMailboxFile();
                    }
                }
            });
            tokenClient.requestAccessToken();
        }

        async function findMailboxFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='messages.txt' and trashed=false`,
                    fields: 'files(id, name, parents)',
                    spaces: 'drive'
                });

                if (response.result.files && response.result.files.length > 0) {
                    fileId = response.result.files[0].id;
                    parentFolderId = response.result.files[0].parents ? response.result.files[0].parents[0] : null;
                    console.log('Mailbox file found:', fileId, 'Parent:', parentFolderId);
                    checkMessages();
                } else {
                    console.log('Mailbox file not found, creating...');
                    await createMailboxFile();
                }
            } catch (error) {
                console.error('Error finding mailbox:', error);
            }
        }

        async function createMailboxFile() {
            try {
                // –°–ø–æ—á–∞—Ç–∫—É –∑–Ω–∞–π—Ç–∏/—Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–∞–ø–∫—É mailbox/q_vadym_chat
                const folderPath = ['mailbox', 'q_vadym_chat'];
                let parentId = 'root';
                
                for (const folderName of folderPath) {
                    const folderResponse = await gapi.client.drive.files.list({
                        q: `name='${folderName}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                        fields: 'files(id)'
                    });
                    
                    if (folderResponse.result.files && folderResponse.result.files.length > 0) {
                        parentId = folderResponse.result.files[0].id;
                    } else {
                        const createFolderResponse = await gapi.client.drive.files.create({
                            resource: {
                                name: folderName,
                                mimeType: 'application/vnd.google-apps.folder',
                                parents: [parentId]
                            },
                            fields: 'id'
                        });
                        parentId = createFolderResponse.result.id;
                    }
                }
                
                // –¢–µ–ø–µ—Ä —Å—Ç–≤–æ—Ä–∏—Ç–∏ messages.txt –≤ –ø–∞–ø—Ü—ñ
                const response = await gapi.client.drive.files.create({
                    resource: {
                        name: 'messages.txt',
                        mimeType: 'text/plain',
                        parents: [parentId]
                    },
                    fields: 'id'
                });
                
                fileId = response.result.id;
                console.log('Mailbox file created:', fileId);
                alert('‚úÖ Mailbox —Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ –≤ mailbox/q_vadym_chat/! –¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.');
                checkMessages();
            } catch (error) {
                console.error('Error creating mailbox:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ–∞–π–ª—É: ' + error.message);
            }
        }

        async function newSession() {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π mailbox —ñ –ø–æ—á–∞—Ç–∏ –Ω–æ–≤–∏–π —Å–µ–∞–Ω—Å?')) {
                return;
            }

            try {
                // –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π —Ñ–∞–π–ª
                if (fileId) {
                    await gapi.client.drive.files.delete({
                        fileId: fileId
                    });
                    console.log('Old mailbox deleted');
                }

                // –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π
                fileId = null;
                await createMailboxFile();
            } catch (error) {
                console.error('Error creating new session:', error);
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Å–µ–∞–Ω—Å—É: ' + error.message);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            if (!fileId) {
                alert('Mailbox —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            try {
                // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ lock —Ñ–∞–π–ª
                const lockExists = await checkLockFile();
                if (lockExists) {
                    alert('‚è≥ QBS –ø–∏—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∑–∞—á–µ–∫–∞–π—Ç–µ...');
                    return;
                }

                // –ó—ñ–±—Ä–∞—Ç–∏ —Ç–µ–ª–µ–º–µ—Ç—Ä—ñ—é
                const telemetry = collectTelemetry();

                // –õ–æ–∫–∞–ª—å–Ω–∏–π —á–∞—Å (–Ω–µ UTC!)
                const now = new Date();
                const timestamp = now.getFullYear() + '-' + 
                    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(now.getDate()).padStart(2, '0') + ' ' +
                    String(now.getHours()).padStart(2, '0') + ':' + 
                    String(now.getMinutes()).padStart(2, '0') + ':' + 
                    String(now.getSeconds()).padStart(2, '0');

                // JSON —Ñ–æ—Ä–º–∞—Ç
                const payload = {
                    message: message,
                    telemetry: telemetry,
                    timestamp: timestamp
                };

                const formattedMessage = `[${timestamp}] [FROM: QMS] [TO: Q]\n${JSON.stringify(payload, null, 2)}\n\n`;

                const currentContent = await readFile();
                const newContent = currentContent + formattedMessage;

                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: newContent
                });

                input.value = '';
                
                // –û–Ω–æ–≤–∏—Ç–∏ UI (–ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –≤–µ—Å—å —Ñ–∞–π–ª –∑–∞–Ω–æ–≤–æ)
                await checkMessages();
            } catch (error) {
                console.error('Error sending message:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }

        function collectTelemetry() {
            const telemetry = {};
            
            if (document.getElementById('cbAccelerometer')?.checked) {
                telemetry.accelerometer = document.getElementById('tvAccelerometer').textContent;
            }
            if (document.getElementById('cbGyroscope')?.checked) {
                telemetry.gyroscope = document.getElementById('tvGyroscope').textContent;
            }
            if (document.getElementById('cbCompass')?.checked) {
                telemetry.compass = document.getElementById('tvCompass').textContent;
            }
            if (document.getElementById('cbBattery')?.checked) {
                telemetry.battery = document.getElementById('tvBattery').textContent;
            }
            if (document.getElementById('cbGPS')?.checked) {
                telemetry.gps = document.getElementById('tvGPS').textContent;
            }
            if (document.getElementById('cbLight')?.checked) {
                telemetry.light = document.getElementById('tvLight').textContent;
            }
            if (document.getElementById('cbPressure')?.checked) {
                telemetry.pressure = document.getElementById('tvPressure').textContent;
            }
            if (document.getElementById('cbProximity')?.checked) {
                telemetry.proximity = document.getElementById('tvProximity').textContent;
            }
            
            return telemetry;
        }

        async function checkMessages() {
            if (!fileId) return;

            try {
                const content = await readFile();
                parseAndDisplayMessages(content);
            } catch (error) {
                console.error('Error checking messages:', error);
            }
        }

        async function readFile() {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            return response.body || '';
        }

        async function checkLockFile() {
            if (!parentFolderId) {
                console.error('Parent folder ID not found');
                return false;
            }
            
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='.lock' and '${parentFolderId}' in parents and trashed=false`,
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });
                const lockExists = response.result.files && response.result.files.length > 0;
                console.log('Lock check:', lockExists);
                return lockExists;
            } catch (error) {
                console.error('Error checking lock:', error);
                return false;
            }
        }

        function parseAndDisplayMessages(content) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';

            if (!content.trim()) {
                messagesDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø–æ–∫–∏ –Ω–µ–º–∞—î</div>';
                return;
            }

            const blocks = content.split('\n\n').filter(b => b.trim());
            
            for (const block of blocks) {
                const lines = block.split('\n');
                const firstLine = lines[0];
                
                // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ SYSTEM –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if (firstLine.includes('[SYSTEM]')) continue;
                
                // –ü–∞—Ä—Å–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ FROM/TO
                const match = firstLine.match(/\[([^\]]+)\].*\[FROM: ([^\]]+)\] \[TO: ([^\]]+)\]/);
                if (match) {
                    const timestamp = match[1];
                    const from = match[2];
                    const text = lines.slice(1).join(' ').trim();
                    
                    if (text) {
                        addMessageToUI(from, text, timestamp);
                    }
                }
            }
        }

        function addMessageToUI(from, text, timestamp) {
            const messagesDiv = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message';
            messageEl.innerHTML = `
                <div class="meta">${from} ‚Ä¢ ${timestamp}</div>
                <div class="text">${text.trim()}</div>
            `;
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Telemetry
        let telemetryInterval = null;

        function startTelemetry() {
            if (telemetryInterval) return;
            
            telemetryInterval = setInterval(() => {
                updateAccelerometer();
                updateGyroscope();
                updateCompass();
                updateBattery();
                updateGPS();
            }, 1000);
        }

        function updateAccelerometer() {
            if (!document.getElementById('cbAccelerometer').checked) return;
            
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (e) => {
                    if (e.accelerationIncludingGravity) {
                        const x = e.accelerationIncludingGravity.x?.toFixed(2) || 0;
                        const y = e.accelerationIncludingGravity.y?.toFixed(2) || 0;
                        const z = e.accelerationIncludingGravity.z?.toFixed(2) || 0;
                        document.getElementById('tvAccelerometer').textContent = `${x}, ${y}, ${z}`;
                    }
                }, { once: true });
            }
        }

        function updateGyroscope() {
            if (!document.getElementById('cbGyroscope').checked) return;
            
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (e) => {
                    if (e.rotationRate) {
                        const alpha = e.rotationRate.alpha?.toFixed(2) || 0;
                        const beta = e.rotationRate.beta?.toFixed(2) || 0;
                        const gamma = e.rotationRate.gamma?.toFixed(2) || 0;
                        document.getElementById('tvGyroscope').textContent = `${alpha}, ${beta}, ${gamma}`;
                    }
                }, { once: true });
            }
        }

        function updateCompass() {
            if (!document.getElementById('cbCompass').checked) return;
            
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (e) => {
                    if (e.alpha !== null) {
                        const heading = Math.round(e.alpha);
                        document.getElementById('tvCompass').textContent = `${heading}¬∞`;
                    }
                }, { once: true });
            }
        }

        function updateBattery() {
            if (!document.getElementById('cbBattery').checked) return;
            
            if (navigator.getBattery) {
                navigator.getBattery().then((battery) => {
                    const level = Math.round(battery.level * 100);
                    document.getElementById('tvBattery').textContent = `${level}%`;
                });
            }
        }

        function updateGPS() {
            if (!document.getElementById('cbGPS').checked) {
                document.getElementById('tvGPS').textContent = 'off';
                return;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lon = position.coords.longitude.toFixed(6);
                        document.getElementById('tvGPS').textContent = `${lat}, ${lon}`;
                    },
                    (error) => {
                        document.getElementById('tvGPS').textContent = 'error';
                    }
                );
            }
        }

        // Start telemetry when mailbox section is shown
        window.addEventListener('load', () => {
            const observer = new MutationObserver(() => {
                if (!document.getElementById('mailboxSection').classList.contains('hidden')) {
                    startTelemetry();
                }
            });
            observer.observe(document.getElementById('mailboxSection'), { attributes: true });
        });

        // Media controls
        let cameraStream = null;
        let micStream = null;

        document.getElementById('cbCamera').addEventListener('change', async (e) => {
            if (e.target.checked) {
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const preview = document.getElementById('cameraPreview');
                    preview.srcObject = cameraStream;
                    preview.style.display = 'block';
                    document.getElementById('cameraStatus').textContent = '‚úÖ Active';
                } catch (error) {
                    document.getElementById('cameraStatus').textContent = '‚ùå Error: ' + error.message;
                    e.target.checked = false;
                }
            } else {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    document.getElementById('cameraPreview').style.display = 'none';
                    document.getElementById('cameraStatus').textContent = '';
                }
            }
        });

        document.getElementById('cbMicrophone').addEventListener('change', async (e) => {
            if (e.target.checked) {
                try {
                    micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    document.getElementById('micStatus').textContent = '‚úÖ Active';
                } catch (error) {
                    document.getElementById('micStatus').textContent = '‚ùå Error: ' + error.message;
                    e.target.checked = false;
                }
            } else {
                if (micStream) {
                    micStream.getTracks().forEach(track => track.stop());
                    document.getElementById('micStatus').textContent = '';
                }
            }
        });

        document.getElementById('cbSpeaker').addEventListener('change', (e) => {
            if (e.target.checked) {
                if ('speechSynthesis' in window) {
                    document.getElementById('speakerStatus').textContent = '‚úÖ Ready';
                } else {
                    document.getElementById('speakerStatus').textContent = '‚ùå Not supported';
                    e.target.checked = false;
                }
            } else {
                document.getElementById('speakerStatus').textContent = '';
            }
        });

        // Volume slider update
        document.getElementById('speakerVolume').addEventListener('input', (e) => {
            document.getElementById('volumeValue').textContent = e.target.value + '%';
        });

        // Media send functions
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        document.getElementById('btnRecord').addEventListener('click', async () => {
            if (!isRecording) {
                // Start recording
                if (!micStream) {
                    alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–º–∫–Ω—ñ—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω!');
                    return;
                }
                
                audioChunks = [];
                mediaRecorder = new MediaRecorder(micStream);
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    
                    reader.onloadend = async () => {
                        const base64Audio = reader.result.split(',')[1];
                        const telemetry = collectTelemetry();
                        const now = new Date();
                        const timestamp = now.getFullYear() + '-' + 
                            String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(now.getDate()).padStart(2, '0') + ' ' +
                            String(now.getHours()).padStart(2, '0') + ':' + 
                            String(now.getMinutes()).padStart(2, '0') + ':' + 
                            String(now.getSeconds()).padStart(2, '0');
                        
                        document.getElementById('btnRecord').textContent = '‚è≥ Sending...';
                        document.getElementById('btnRecord').disabled = true;
                        
                        try {
                            const payload = {
                                action: 'audio_record',
                                media: {
                                    type: 'audio',
                                    data: base64Audio,
                                    format: 'webm'
                                },
                                telemetry: telemetry,
                                timestamp: timestamp
                            };
                            
                            const formattedMessage = `[${timestamp}] [FROM: QMS] [TO: Q]\n${JSON.stringify(payload, null, 2)}\n\n`;
                            
                            const currentContent = await readFile();
                            const newContent = currentContent + formattedMessage;
                            
                            await gapi.client.request({
                                path: `/upload/drive/v3/files/${fileId}`,
                                method: 'PATCH',
                                params: { uploadType: 'media' },
                                body: newContent
                            });
                            
                            await checkMessages();
                        } catch (error) {
                            alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + error.message);
                        }
                        
                        document.getElementById('btnRecord').textContent = 'üé§ Record';
                        document.getElementById('btnRecord').disabled = false;
                    };
                    
                    reader.readAsDataURL(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('btnRecord').textContent = 'üî¥ Recording...';
                document.getElementById('btnRecord').style.background = '#e74c3c';
            } else {
                // Stop recording
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('btnRecord').textContent = 'üé§ Record';
                document.getElementById('btnRecord').style.background = '#3498db';
            }
        });

        // Send Frame
        document.getElementById('btnSendFrame').addEventListener('click', async () => {
            if (!cameraStream) {
                alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–º–∫–Ω—ñ—Ç—å –∫–∞–º–µ—Ä—É!');
                return;
            }
            
            try {
                document.getElementById('btnSendFrame').disabled = true;
                document.getElementById('btnSendFrame').textContent = 'üì∏ Sending...';
                
                const video = document.createElement('video');
                video.srcObject = cameraStream;
                video.play();
                
                await new Promise(resolve => {
                    video.onloadedmetadata = resolve;
                });
                
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                const telemetry = collectTelemetry();
                const now = new Date();
                const timestamp = now.getFullYear() + '-' + 
                    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(now.getDate()).padStart(2, '0') + ' ' +
                    String(now.getHours()).padStart(2, '0') + ':' + 
                    String(now.getMinutes()).padStart(2, '0') + ':' + 
                    String(now.getSeconds()).padStart(2, '0');
                
                const payload = {
                    action: 'camera_frame',
                    media: {
                        type: 'frame',
                        data: imageData
                    },
                    telemetry: telemetry,
                    timestamp: timestamp
                };
                
                const formattedMessage = `[${timestamp}] [FROM: QMS] [TO: Q]\n${JSON.stringify(payload, null, 2)}\n\n`;
                
                const currentContent = await readFile();
                const newContent = currentContent + formattedMessage;
                
                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: newContent
                });
                
                await checkMessages();
                
                document.getElementById('btnSendFrame').textContent = 'üì∏ Send Frame';
                document.getElementById('btnSendFrame').disabled = false;
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
                document.getElementById('btnSendFrame').textContent = 'üì∏ Send Frame';
                document.getElementById('btnSendFrame').disabled = false;
            }
        });

        // Send Motion
        document.getElementById('btnSendMotion').addEventListener('click', async () => {
            if (!cameraStream) {
                alert('–°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–º–∫–Ω—ñ—Ç—å –∫–∞–º–µ—Ä—É!');
                return;
            }
            
            try {
                const frameCount = parseInt(document.getElementById('motionFrames').value) || 5;
                
                document.getElementById('btnSendMotion').disabled = true;
                document.getElementById('btnSendMotion').textContent = 'üé¨ Capturing...';
                
                const frames = [];
                for (let i = 0; i < frameCount; i++) {
                    const video = document.createElement('video');
                    video.srcObject = cameraStream;
                    video.play();
                    
                    await new Promise(resolve => {
                        video.onloadedmetadata = resolve;
                    });
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);
                    
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    frames.push(imageData);
                    
                    if (i < frameCount - 1) await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                document.getElementById('btnSendMotion').textContent = 'üé¨ Sending...';
                
                const telemetry = collectTelemetry();
                const now = new Date();
                const timestamp = now.getFullYear() + '-' + 
                    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(now.getDate()).padStart(2, '0') + ' ' +
                    String(now.getHours()).padStart(2, '0') + ':' + 
                    String(now.getMinutes()).padStart(2, '0') + ':' + 
                    String(now.getSeconds()).padStart(2, '0');
                
                const payload = {
                    action: 'camera_motion',
                    media: {
                        type: 'motion',
                        frames: frames,
                        count: frameCount
                    },
                    telemetry: telemetry,
                    timestamp: timestamp
                };
                
                const formattedMessage = `[${timestamp}] [FROM: QMS] [TO: Q]\n${JSON.stringify(payload, null, 2)}\n\n`;
                
                const currentContent = await readFile();
                const newContent = currentContent + formattedMessage;
                
                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: newContent
                });
                
                await checkMessages();
                
                document.getElementById('btnSendMotion').textContent = 'üé¨ Send Motion';
                document.getElementById('btnSendMotion').disabled = false;
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
                document.getElementById('btnSendMotion').textContent = 'üé¨ Send Motion';
                document.getElementById('btnSendMotion').disabled = false;
            }
        });

        // Test Voice - –ø—Ä–æ–º–æ–≤–ª—è—î —Ç–µ–∫—Å—Ç –ª–æ–∫–∞–ª—å–Ω–æ
        document.getElementById('btnTestVoice').addEventListener('click', () => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('–¢–µ—Å—Ç –≥–æ–ª–æ—Å—É');
                const rate = parseFloat(document.getElementById('speakerRate').value) || 1.0;
                const volume = parseInt(document.getElementById('speakerVolume').value) / 100 || 1.0;
                utterance.rate = rate;
                utterance.volume = volume;
                utterance.lang = 'uk-UA';
                speechSynthesis.speak(utterance);
            } else {
                alert('Speech Synthesis –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
            }
        });

        // Refresh Clipboard - –æ–Ω–æ–≤–ª—é—î –ø—Ä–µ–≤ º—é
        document.getElementById('btnRefreshClipboard').addEventListener('click', async () => {
            try {
                const items = await navigator.clipboard.read();
                for (const item of items) {
                    if (item.types.includes('image/png')) {
                        const blob = await item.getType('image/png');
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.getElementById('screenPreview');
                            const ctx = canvas.getContext('2d');
                            const scale = Math.min(200 / img.width, 150 / img.height);
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            canvas.style.display = 'block';
                            document.getElementById('clipboardStatus').textContent = '‚úÖ Image in clipboard';
                        };
                        img.src = URL.createObjectURL(blob);
                        return;
                    }
                }
                document.getElementById('clipboardStatus').textContent = 'üìã No image in clipboard';
            } catch (error) {
                document.getElementById('clipboardStatus').textContent = '‚ùå Error: ' + error.message;
            }
        });

        // Send Clipboard - —á–∏—Ç–∞—î clipboard —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î image
        document.getElementById('btnSendClipboard').addEventListener('click', async () => {
            try {
                document.getElementById('btnSendClipboard').disabled = true;
                document.getElementById('btnSendClipboard').textContent = 'üìã Sending...';
                
                const items = await navigator.clipboard.read();
                let imageData = null;
                
                for (const item of items) {
                    if (item.types.includes('image/png')) {
                        const blob = await item.getType('image/png');
                        const reader = new FileReader();
                        imageData = await new Promise(resolve => {
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(blob);
                        });
                        break;
                    }
                }
                
                if (!imageData) {
                    throw new Error('No image in clipboard');
                }
                
                const telemetry = collectTelemetry();
                const now = new Date();
                const timestamp = now.getFullYear() + '-' + 
                    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(now.getDate()).padStart(2, '0') + ' ' +
                    String(now.getHours()).padStart(2, '0') + ':' + 
                    String(now.getMinutes()).padStart(2, '0') + ':' + 
                    String(now.getSeconds()).padStart(2, '0');
                
                const payload = {
                    action: 'clipboard_send',
                    media: {
                        type: 'clipboard',
                        data: imageData
                    },
                    telemetry: telemetry,
                    timestamp: timestamp
                };
                
                const formattedMessage = `[${timestamp}] [FROM: QMS] [TO: Q]\n${JSON.stringify(payload, null, 2)}\n\n`;
                
                const currentContent = await readFile();
                const newContent = currentContent + formattedMessage;
                
                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: newContent
                });
                
                await checkMessages();
                
                document.getElementById('btnSendClipboard').textContent = '‚úÖ Sent!';
                setTimeout(() => {
                    document.getElementById('btnSendClipboard').textContent = 'üìã Send Clipboard';
                    document.getElementById('btnSendClipboard').disabled = false;
                }, 2000);
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
                document.getElementById('btnSendClipboard').textContent = 'üìã Send Clipboard';
                document.getElementById('btnSendClipboard').disabled = false;
            }
        });

        async function sendMediaMessage(action, mediaData) {
            if (!fileId) {
                alert('Mailbox —Ñ–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            try {
                const lockExists = await checkLockFile();
                if (lockExists) {
                    alert('‚è≥ QBS –ø–∏—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –∑–∞—á–µ–∫–∞–π—Ç–µ...');
                    return;
                }

                const telemetry = collectTelemetry();
                const now = new Date();
                const timestamp = now.getFullYear() + '-' + 
                    String(now.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(now.getDate()).padStart(2, '0') + ' ' +
                    String(now.getHours()).padStart(2, '0') + ':' + 
                    String(now.getMinutes()).padStart(2, '0') + ':' + 
                    String(now.getSeconds()).padStart(2, '0');

                const payload = {
                    action: action,
                    media: mediaData,
                    telemetry: telemetry,
                    timestamp: timestamp
                };

                const formattedMessage = `[${timestamp}] [FROM: QMS] [TO: Q]\n${JSON.stringify(payload, null, 2)}\n\n`;

                const currentContent = await readFile();
                const newContent = currentContent + formattedMessage;

                await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'media' },
                    body: newContent
                });

                await checkMessages();
            } catch (error) {
                console.error('Error sending media:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + error.message);
            }
        }
    </script>
</body>
</html>
